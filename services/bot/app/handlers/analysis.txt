
#==============================================================================================================================================================================================
# Unit analysis
#==============================================================================================================================================================================================


@router.callback_query(F.data.startswith("analise_unit"))
async def analyse_unit_menu(callback: CallbackQuery, state: FSMContext, bot:Bot):
    try:
        await state.clear()
        set_id, unit_id = callback.data.split("_")[2:]
        await callback.message.answer(
            "–ú–µ–Ω—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏",
            reply_markup= await inline_keyboards.create_unit_edit_menu(set_id, unit_id)
        )
    except Exception as e:
        logging.error(e)
        await callback.message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∏–∑–≤–∏–Ω–∏—Ç–µ", reply_markup= inline_keyboards.main)
    await build_log_message(
        telegram_id=callback.from_user.id,
        action="callback",
        source="inline",
        payload="analize_unit_menu"
    )

def escape_md_v2(text: str) -> str:
    if text is None:
        return ""
    text = str(text)
    escape_chars = r"_*[]()~`>#+-=|{}.!\\"
    return re.sub(f"([{re.escape(escape_chars)}])", r'\\\1', text)

def format_unit_report(data: dict) -> str:
    get = lambda key: escape_md_v2(data.get(key))
    return f"""
üìä *–û—Ç—á–µ—Ç –ø–æ —é–Ω–∏—Ç\\-—ç–∫–æ–Ω–æ–º–∏–∫–µ*

*–ù–∞–∑–≤–∞–Ω–∏–µ:* `{get('name')}`
*–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:* `{get('users')}`
*–ö–ª–∏–µ–Ω—Ç—ã:* `{get('customers')}`
*avp:* `{get('avp')}`
*apc:* `{get('apc')}`
*tms:* `{get('tms')}`
*cogs:* `{get('cogs')}`
*cogs1s:* `{get('cogs1s')}`
*fc:* `{get('fc')}`

üî¢ *–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:*
\\- C1 \\(–∫–æ–Ω–≤–µ—Ä—Å–∏—è\\): {get("C1")}
\\- ARPC \\(–¥–æ—Ö–æ–¥ —Å –∫–ª–∏–µ–Ω—Ç–∞\\): {get("ARPC")}
\\- ARPU \\(–¥–æ—Ö–æ–¥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\\): {get("ARPU")}
\\- CPA \\(—Ü–µ–Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\\): {get("CPA")}
\\- CAC \\(—Ü–µ–Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\\): {get("CAC")}

üí∞ *–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å:*
\\- CLTV \\(–ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞\\): {get("CLTV")}
\\- LTV \\(—Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ —Å —É—á–µ—Ç–æ–º C1\\): {get("LTV")}
\\- ROI: {get("ROI")} \\%
\\- UCM \\(—é–Ω–∏—Ç\\-contrib\\-–º–∞—Ä–∂–∞\\): {get("UCM")}
\\- CCM \\(–∫–ª–∏–µ–Ω—Ç\\-contrib\\-–º–∞—Ä–∂–∞\\): {get("CCM")}

üìà *–í—ã—Ä—É—á–∫–∞ –∏ –ø—Ä–∏–±—ã–ª—å:*
\\- Revenue \\(–≤—ã—Ä—É—á–∫–∞\\): {get("Revenue")}
\\- Gross Profit \\(–≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å\\): {get("Gross_profit")}
\\- Margin \\(–º–∞—Ä–∂–∞\\): {get("Margin")}
\\- fc \\(–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏\\): {get("fc")}
\\- Profit \\(–ø—Ä–∏–±—ã–ª—å\\): {get("Profit")}

‚öñÔ∏è *–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å:*
\\- –¢—Ä–µ–±—É–µ—Ç—Å—è —é–Ω–∏—Ç–æ–≤ –¥–æ BEP: {get("Required_units_to_BEP")}
\\- BEP \\(—Ç–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏\\): {get("BEP")}

üìå *–ü—Ä–∏–±—ã–ª—å–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å:* {"‚úÖ –î–∞" if data.get("CCM", 0)>0 else "‚ùå –ù–µ—Ç"}
""".strip()


def format_bep_report(data: dict) -> str:
    get = lambda key: escape_md_v2(data.get(key, "Undefined"))
    return f"""
üìä *–û—Ç—á–µ—Ç –æ —Ç–æ—á–∫–µ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏*

üí∞ *–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏:*
*–ù–∞–∑–≤–∞–Ω–∏–µ:* `{get('name')}`
*–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:* `{get('users')}`
*–ö–ª–∏–µ–Ω—Ç—ã:* `{get('customers')}`
*avp:* `{get('avp')}`
*apc:* `{get('apc')}`
*tms:* `{get('tms')}`
*cogs:* `{get('cogs')}`
*cogs1s:* `{get('cogs1s')}`
*fc:* `{get('fc')}`


üí∞ *–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç –º–æ–¥–µ–ª–∏:*
\\- CCM \\(–∫–ª–∏–µ–Ω—Ç\\-contrib\\-–º–∞—Ä–∂–∞\\): {get("CCM")}
\\- fc \\(–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏\\): {get("fc")}

‚öñÔ∏è *–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å:*
\\- –¢—Ä–µ–±—É–µ—Ç—Å—è —é–Ω–∏—Ç–æ–≤ –¥–æ BEP: {get("Required_units_to_BEP")}
\\- BEP \\(—Ç–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏\\): {get("BEP")}

üìå *–ü—Ä–∏–±—ã–ª—å–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å:* {"‚úÖ –î–∞" if data.get("CCM", 0)>0 else "‚ùå –ù–µ—Ç"}
""".strip()

@router.callback_query(F.data.startswith("count_unit_economics_"))
async def count_unit_economics(callback: CallbackQuery, state: FSMContext, bot:Bot):
    try:
        print(callback.data.split("_")[2:])
        set_id, unit_id = callback.data.split("_")[3:]
        analysis = await get_unit_report.get_unit_report(
            telegram_id=callback.from_user.id,
            unit_id=unit_id
        )
        if not analysis:
            raise ValueError("Error while generating report")

        await callback.message.answer(
            format_unit_report(analysis[0]),
            reply_markup = inline_keyboards.main,
            parse_mode="MarkdownV2"
        )
    except Exception as e:
        logging.error(e)
        await callback.message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏", reply_markup= inline_keyboards.main)
    finally:
        await state.clear()
    await build_log_message(
        telegram_id=callback.from_user.id,
        action="callback",
        source="inline",
        payload="count_unit_economics"
    )
#==============================================================================================================================================================================================
# Count unit BEP
#==============================================================================================================================================================================================


@router.callback_query(F.data.startswith("count_unit_bep"))
async def count_unit_bep(callback: CallbackQuery, state: FSMContext, bot:Bot):
    try:
        await state.clear()
        set_id, model_id = callback.data.split("_")[3:]
        await callback.answer()

        analysis = await get_unit_report.get_unit_report(
            telegram_id=callback.from_user.id,
            unit_id=model_id
        )

        if not analysis:
            logging.error("Failed to get report")
            await callback.message.answer(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö üòî",
                reply_markup=inline_keyboards.main)
            await callback.answer()
            return
        analysis = analysis[0]

        if not analysis.get("Required_units_to_BEP") or analysis.get("UCM")<=0:
            await callback.message.answer(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —É–±—ã—Ç–æ—á–Ω–∞",
            )
            await callback.message.answer(
                "–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞",
            )
            await callback.message.answer(
                format_bep_report(analysis),
                reply_markup=inline_keyboards.main,
                parse_mode = "MarkdownV2"
            )
            await callback.answer()
            return

        image_bytes_list = await get_unit_bep.get_unit_bep(telegram_id=callback.from_user.id, unit_id=model_id)

        if not image_bytes_list:
            logging.error("Failed to get visual report images from API.")
            await callback.message.answer(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö üòî",
                reply_markup=inline_keyboards.main)
            await callback.answer()
            return
        
        first_photo = BufferedInputFile(image_bytes_list[0], filename="report_1.png")
        caption_text = "üìä –í–æ—Ç –≤–∞—à –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Ç–æ—á–∫–µ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏! üìà"
        analysis = await get_unit_report.get_unit_report(
            telegram_id=callback.from_user.id,
            unit_id=model_id
        )
        if not analysis:
            raise ValueError("Error while generating report")
        await callback.message.answer_photo(
            photo=first_photo,
            caption=caption_text
        )

        for ind, photo_bytes in enumerate(image_bytes_list[1:], start=2):
            if photo_bytes is None:
                continue
            photo_file = BufferedInputFile(photo_bytes, filename=f"report_{ind}.png")
            await callback.message.answer_photo(
                photo=photo_file
            )

        await callback.message.answer(
            format_bep_report(analysis[0]),
            reply_markup=inline_keyboards.main,
            parse_mode = "MarkdownV2"
        )
    except Exception as e:
        logging.error(e)
        await callback.message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ç–æ—á–∫—É –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏", reply_markup= inline_keyboards.main)
    finally:
        await state.clear()
    await build_log_message(
        telegram_id=callback.from_user.id,
        action="callback",
        source="inline",
        payload="count_unit_bep"
    )

#==============================================================================================================================================================================================
# Generate unit report
#==============================================================================================================================================================================================

@router.callback_query(F.data.startswith("generate_report_unit"))
async def generate_unit_report(callback: CallbackQuery, state: FSMContext, bot:Bot):
    try:
        await state.clear()
        set_id, model_id = callback.data.split("_")[3:]
        await callback.answer()

        analysis = await get_unit_report.get_unit_report(
            telegram_id=callback.from_user.id,
            unit_id=model_id
        )

        if not analysis:
            logging.error("Failed to get report")
            await callback.message.answer(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö üòî",
                reply_markup=inline_keyboards.main)
            await callback.answer()
            return
        analysis = analysis[0]


        await callback.answer("–ì–æ—Ç–æ–≤–ª—é –≤–∞—à –æ—Ç—á—ë—Ç...", show_alert=False)
        docs = await get_unit_exel.get_unit_exel(telegram_id=callback.from_user.id, unit_id=model_id)

        if not docs:
            await callback.message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.")
            return

        await callback.message.answer(
            "–í–æ—Ç –≤–∞—à –æ—Ç—á—ë—Ç!"
        )

        await bot.send_document(
            chat_id=callback.message.chat.id,
            document=BufferedInputFile(docs.getvalue(), filename="report.xlsx"),
            reply_markup=inline_keyboards.main
        )
        await state.clear()


    except Exception as e:
        logging.error(e)
        await callback.message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ç–æ—á–∫—É –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏", reply_markup= inline_keyboards.main)
    finally:
        await state.clear()
    await build_log_message(
        telegram_id=callback.from_user.id,
        action="callback",
        source="inline",
        payload="count_bep_unit"
    )


#===========================================================================================================================
# Unit –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
#===========================================================================================================================

@router.callback_query(F.data.startswith("cohort_analisis_"))
async def start_cohort_analisis(callback: CallbackQuery, state: FSMContext, bot:Bot):
    try:
        await state.clear()
        set_id, model_id = callback.data.split("_")[2:]
        await callback.answer()
        await state.set_state(Cohort.handle_unit)
        await state.update_data(set_id = set_id)
        await state.update_data(model_id = model_id)

        """
        analysis = await get_unit_report.get_unit_report(
            telegram_id=callback.from_user.id,
            unit_id=model_id
        )
        if not analysis:
            logging.error("Failed to get report")
            await callback.message.answer(
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö üòî",
                reply_markup=inline_keyboards.main)
            await callback.answer()
            return
        analysis = analysis[0]
        """
        await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (retention rate, %)")
    except Exception as e:
        logging.error(e)
        await callback.message.answer("–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ", reply_markup= inline_keyboards.main)


@router.message(Cohort.handle_unit)
async def continue_cohort_analisis(message:Message, state: FSMContext, bot:Bot):
    retention = message.text
    try:
        if not retention:
            raise ValueError("Invalid retention rate given")
        retention = float(retention)
        await state.update_data(retention = retention)
        await state.set_state(Cohort.retention_rate)
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –æ–∂–∏–¥–∞–µ–º—ã–π –º–µ—Å—è—á–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (audience growth rate, %)")

    except Exception as e:
        logging.exception(e)
        await message.answer("–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ", reply_markup= inline_keyboards.main)
        raise


@router.message(Cohort.retention_rate)
async def finish_cohort_analisis(message:Message, state: FSMContext, bot:Bot):
    growth = message.text
    try:
        if not growth:
            raise ValueError("Invalid retention rate given")
        growth = float(growth)
        data = await state.get_data()
        set_id = data.get("set_id")
        model_id = data.get("model_id")
        retention = data.get("retention")
        await state.clear()
        result = await update_model_cohort_data.update_model_cohort_data(
            telegram_id=message.from_user.id,
            set_id = set_id,
            model_id = model_id,
            retention = retention,
            growth = growth
        )
        if not result:
            raise Exception("Error while patching model")
        
        zip_buf = await get_unit_cohort(
            telegram_id= message.from_user.id,
            unit_id= model_id
        )
        if not zip_buf:
            raise Exception("Error while getting report from the server")
        zip_buf = io.BytesIO(zip_buf)
        with zipfile.ZipFile(zip_buf, 'r') as zip_ref:
            for filename in zip_ref.namelist():
                if filename.endswith(('.png', '.xlsx')): 
                    file_bytes = zip_ref.read(filename)
                    file_buf = io.BytesIO(file_bytes)
                    file_buf.seek(0)

                    document = BufferedInputFile(file_buf.read(), filename=filename)
                    await bot.send_document(chat_id=message.from_user.id, document=document)
        await message.answer("–í–∞—à –æ—Ç—á–µ—Ç –≥–æ—Ç–æ–≤!", reply_markup= inline_keyboards.main)

    except Exception as e:
        logging.exception(e)
        await message.answer("–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ", reply_markup= inline_keyboards.main)
        raise
    finally:
        await state.clear()
    await build_log_message(
        telegram_id=message.from_user.id,
        action="callback",
        source="inline",
        payload="count_unit_cohort"
    )
